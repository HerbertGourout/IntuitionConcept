# üèóÔ∏è Syst√®me d'Analyse de Plans Architecturaux Sans Perte

## üìã Vue d'ensemble

Syst√®me complet d'analyse de plans architecturaux BTP pr√©servant **100% de la qualit√©** des documents PDF originaux, utilisant l'API Claude (Anthropic) pour une extraction intelligente et structur√©e.

---

## ‚ú® Caract√©ristiques principales

### üéØ Qualit√© pr√©serv√©e √† 100%
- ‚úÖ **Aucune compression** des fichiers PDF
- ‚úÖ **Aucune perte de r√©solution** ou de m√©tadonn√©es
- ‚úÖ **Polices et mise en page** int√©gralement conserv√©es
- ‚úÖ **Annotations et calques** pr√©serv√©s

### üìÑ D√©coupe intelligente
- ‚úÇÔ∏è S√©paration par page sans alt√©ration
- üìä Extraction de m√©tadonn√©es compl√®tes
- üîç Analyse s√©quentielle optimis√©e
- üíæ Gestion de fichiers volumineux (>100 MB)

### ü§ñ Analyse IA avanc√©e
- üß† API Claude 3.5 Sonnet (Anthropic)
- üìê Extraction de mesures pr√©cises
- üè† Identification des espaces et pi√®ces
- üß± D√©tection des mat√©riaux et √©l√©ments structurels
- üìã G√©n√©ration automatique de devis

---

## üèóÔ∏è Architecture

### Services cr√©√©s

#### 1. **ClaudeServiceDirect** (`src/services/ai/claudeServiceDirect.ts`)
Service de communication directe avec l'API Anthropic Claude.

**Fonctionnalit√©s :**
- Communication directe avec API Claude (sans proxy)
- Support des 3 mod√®les : Opus, Sonnet, Haiku
- Analyse PDF native avec documents attach√©s
- Calcul automatique des co√ªts (FCFA)
- Health check et gestion d'erreurs robuste

**Mod√®les disponibles :**
```typescript
ClaudeServiceDirect.getAvailableModels()
// {
//   SONNET: 'claude-sonnet-4-5-20250929',    // ‚úÖ Recommand√© (snapshot le plus r√©cent)
//   SONNET_4: 'claude-sonnet-4-20250514',    // Snapshot pr√©c√©dent
//   SONNET_3_7: 'claude-3-7-sonnet-20250219',// Version 3.7 long support
//   OPUS_4_1: 'claude-opus-4.1-20250805',    // Qualit√© maximale, co√ªt √©lev√©
//   OPUS_4: 'claude-opus-4-20250514',
//   HAIKU_3_5: 'claude-3-5-haiku-20241022'   // Rapide et √©conomique
// }
```

**Co√ªts par mod√®le (FCFA) :**
- **Sonnet 4.5 / 4 / 3.7** : 0.0018 FCFA/token input, 0.009 FCFA/token output
- **Opus 4.1 / 4** : 0.015 FCFA/token input, 0.075 FCFA/token output
- **Haiku 3.5** : 0.0006 FCFA/token input, 0.0018 FCFA/token output

#### 2. **PDFSplitter** (`src/utils/pdfSplitter.ts`)
Service de d√©coupe PDF sans compression.

**Fonctionnalit√©s :**
- D√©coupe par page sans perte de qualit√©
- Extraction de m√©tadonn√©es compl√®tes (auteur, titre, dates, etc.)
- Analyse des caract√©ristiques de chaque page
- Fusion de pages
- Validation de fichiers PDF

**M√©tadonn√©es extraites :**
- Informations document (titre, auteur, sujet, mots-cl√©s)
- Dates (cr√©ation, modification)
- Informations techniques (producteur, cr√©ateur, version PDF)
- Statistiques par page (dimensions, rotation, contenu)

#### 3. **ArchitecturalPlanAnalyzer** (composant React)
Interface utilisateur moderne pour l'analyse de plans.

**Workflow :**
1. **Upload** : Glisser-d√©poser ou s√©lection de fichier PDF
2. **Validation** : V√©rification et extraction de m√©tadonn√©es
3. **D√©coupe** : S√©paration en pages sans compression
4. **Analyse** : Traitement par Claude avec prompt architectural
5. **R√©sultats** : Affichage structur√© + g√©n√©ration de devis

---

## üöÄ Installation et configuration

### 1. Installer les d√©pendances

```bash
npm install @anthropic-ai/sdk pdf-lib
```

### 2. Configurer la cl√© API Claude

Ajouter dans `.env.local` :

```env
# API Anthropic Claude
VITE_ANTHROPIC_API_KEY=sk-ant-api03-xxxxxxxxxxxxx
```

### 3. Obtenir une cl√© API

1. Cr√©er un compte sur [console.anthropic.com](https://console.anthropic.com)
2. G√©n√©rer une cl√© API dans la section "API Keys"
3. Copier la cl√© dans `.env.local`

---

## üíª Utilisation

### Utilisation du composant React

```tsx
import ArchitecturalPlanAnalyzer from './components/AI/ArchitecturalPlanAnalyzer';

function App() {
  return (
    <div>
      <ArchitecturalPlanAnalyzer />
    </div>
  );
}
```

### Utilisation programmatique

#### Initialiser le service Claude

```typescript
import { initializeClaudeServiceDirect, ClaudeServiceDirect } from './services/ai/claudeServiceDirect';

// Initialiser avec cl√© API (Sonnet 4.5 recommand√© pour √©quilibre performance/co√ªt)
const claudeService = initializeClaudeServiceDirect(
  'sk-ant-api03-xxxxx',
  ClaudeServiceDirect.getAvailableModels().SONNET
);

// V√©rifier la sant√© du service
const isHealthy = await claudeService.healthCheck();
console.log('Service Claude op√©rationnel:', isHealthy);
```

#### Analyser un plan PDF

```typescript
// Analyser un fichier PDF
const analysisResult = await claudeService.analyzePDFArchitecturalPlan(pdfFile, {
  preserveQuality: true,
  splitByPage: true,
  extractMetadata: true,
  maxPagesPerRequest: 5,
  includeImages: true
});

console.log('Donn√©es architecturales:', analysisResult.architecturalData);
console.log('Co√ªt:', analysisResult.metadata.cost, 'FCFA');
console.log('Dur√©e:', analysisResult.metadata.processingTime, 'ms');
```

#### D√©couper un PDF sans perte

```typescript
import { PDFSplitter } from './utils/pdfSplitter';

// D√©couper le PDF
const splitResult = await PDFSplitter.splitPDF(pdfFile, {
  preserveMetadata: true,
  preserveQuality: true,
  extractImages: true,
  includeAnnotations: true
});

console.log(`${splitResult.pages.length} pages extraites`);
console.log('M√©tadonn√©es:', splitResult.originalMetadata);

// Acc√©der √† chaque page
splitResult.pages.forEach(page => {
  console.log(`Page ${page.pageNumber}:`, {
    base64: page.base64,
    dimensions: `${page.metadata.width}x${page.metadata.height}`,
    taille: `${(page.pdfBytes.length / 1024).toFixed(2)} KB`
  });
});
```

---

## üìä Donn√©es extraites

### Structure ArchitecturalPlanData

```typescript
interface ArchitecturalPlanData {
  // Type de plan
  planType: 'floor_plan' | 'elevation' | 'section' | 'site_plan' | 'detail' | 'structural' | 'electrical' | 'plumbing';
  
  // Mesures et dimensions
  measurements: {
    totalArea?: number; // Surface totale en m¬≤
    rooms?: Array<{
      name: string;
      area: number;
      dimensions: { length: number; width: number; height?: number };
      floor?: number;
      purpose?: string;
    }>;
    walls?: Array<{
      type: 'load_bearing' | 'partition' | 'exterior' | 'interior';
      material: string;
      thickness: number;
      length: number;
    }>;
    openings?: Array<{
      type: 'door' | 'window' | 'opening';
      dimensions: { width: number; height: number };
      location: string;
    }>;
  };
  
  // Mat√©riaux identifi√©s
  materials: Array<{
    category: string;
    name: string;
    specification?: string;
    quantity?: number;
    unit?: string;
  }>;
  
  // Annotations du plan
  annotations: string[];
  
  // Sp√©cifications techniques
  technicalSpecs: Record<string, string>;
  
  // Conformit√© r√©glementaire
  compliance: {
    buildingCode?: string;
    standards?: string[];
    regulations?: string[];
  };
  
  // Complexit√© estim√©e
  estimatedComplexity: 'low' | 'moderate' | 'high' | 'very_high';
  
  // Niveau de confiance
  confidence: number; // 0-1
}
```

---

## üéØ Prompt d'analyse architectural

Le syst√®me utilise un prompt optimis√© pour extraire **toutes** les informations techniques :

### Sections extraites :
1. **Identification du type de plan**
2. **Mesures et dimensions** (surfaces, cotes, hauteurs)
3. **Nomenclature des espaces** (pi√®ces, fonctions, orientations)
4. **√âl√©ments structurels** (murs, poteaux, poutres, dalles)
5. **Ouvertures** (portes, fen√™tres, baies)
6. **Mat√©riaux sp√©cifi√©s** (rev√™tements, menuiseries, isolants)
7. **Annotations techniques** (notes, sp√©cifications, l√©gendes)
8. **Conformit√© r√©glementaire** (codes, normes, DTU)
9. **Estimation de complexit√©**

### R√®gles critiques :
- ‚úÖ Pr√©cision absolue (pas d'approximation)
- ‚úÖ Exhaustivit√© (rien n'est omis)
- ‚úÖ Unit√©s toujours sp√©cifi√©es
- ‚úÖ JSON valide et parsable
- ‚úÖ Null si donn√©e non lisible

---

## üí∞ Estimation des co√ªts

### Exemple de co√ªt pour un plan de 10 pages :

**Avec Claude 3.5 Sonnet (recommand√©) :**
- Input : ~50,000 tokens (PDF + prompt) √ó 0.0018 FCFA = **90 FCFA**
- Output : ~5,000 tokens (analyse JSON) √ó 0.009 FCFA = **45 FCFA**
- **Total : ~135 FCFA par analyse**

**Avec Claude 3 Opus (maximum de pr√©cision) :**
- Input : ~50,000 tokens √ó 0.009 FCFA = **450 FCFA**
- Output : ~5,000 tokens √ó 0.045 FCFA = **225 FCFA**
- **Total : ~675 FCFA par analyse**

**Avec Claude 3.5 Haiku (√©conomique) :**
- Input : ~50,000 tokens √ó 0.0006 FCFA = **30 FCFA**
- Output : ~5,000 tokens √ó 0.0018 FCFA = **9 FCFA**
- **Total : ~39 FCFA par analyse**

---

## üîß Optimisations

### Gestion des fichiers volumineux

Le syst√®me d√©coupe automatiquement les PDF en batches :

```typescript
// Configuration par d√©faut
const options = {
  maxPagesPerRequest: 5 // 5 pages par requ√™te Claude
};

// Pour un PDF de 50 pages :
// ‚Üí 10 requ√™tes Claude
// ‚Üí Analyse s√©quentielle
// ‚Üí Agr√©gation des r√©sultats
```

### Cache et r√©utilisation

```typescript
// Le service conserve l'instance initialis√©e
const claudeService = getClaudeServiceDirect();

// R√©utiliser pour plusieurs analyses
const result1 = await claudeService.analyzePDFArchitecturalPlan(file1);
const result2 = await claudeService.analyzePDFArchitecturalPlan(file2);
```

---

## üõ°Ô∏è S√©curit√©

### Protection de la cl√© API

- ‚úÖ Cl√© stock√©e dans `.env.local` (gitignored)
- ‚úÖ Jamais expos√©e c√¥t√© client
- ‚úÖ Validation avant chaque requ√™te
- ‚úÖ Health check automatique

### Validation des fichiers

```typescript
// Validation automatique
const validation = await PDFSplitter.validatePDF(file);
if (!validation.valid) {
  console.error('PDF invalide:', validation.error);
}
```

---

## üìà Monitoring et logs

Le syst√®me log automatiquement :

```
üìÑ Fichier upload√©: plan.pdf (6.12 MB)
üìä M√©tadonn√©es PDF: { pageCount: 15, title: "Plan R+2", ... }
‚úÇÔ∏è D√©coupe PDF par page (qualit√© 100% pr√©serv√©e)...
üìë 15 pages extraites sans perte
‚úÖ Service Claude initialis√© et op√©rationnel
üîç Analyse architecturale avec Claude (PDF natif)...
‚úÖ Analyse Claude termin√©e
üí∞ Co√ªt: 145.50 FCFA
‚è±Ô∏è Dur√©e: 12.3s
üéâ Analyse compl√®te termin√©e avec succ√®s!
```

---

## üêõ R√©solution de probl√®mes

### Erreur : "Cl√© API Anthropic manquante"

**Solution :**
1. V√©rifier que `VITE_ANTHROPIC_API_KEY` est dans `.env.local`
2. Red√©marrer le serveur de d√©veloppement
3. V√©rifier que la cl√© commence par `sk-ant-api03-`

### Erreur : "Service Claude non disponible"

**Solution :**
1. V√©rifier la connexion internet
2. Tester la cl√© API sur [console.anthropic.com](https://console.anthropic.com)
3. V√©rifier les quotas API

### Erreur : "PDF invalide"

**Solution :**
1. V√©rifier que le fichier est bien un PDF
2. Tester avec un autre lecteur PDF
3. Essayer de r√©g√©n√©rer le PDF depuis la source

---

## üìö Ressources

### Documentation officielle
- [API Anthropic Claude](https://docs.anthropic.com/claude/reference/getting-started-with-the-api)
- [pdf-lib Documentation](https://pdf-lib.js.org/)

### Exemples de code
- Voir `src/components/AI/ArchitecturalPlanAnalyzer.tsx` pour l'impl√©mentation compl√®te
- Voir `src/services/ai/claudeServiceDirect.ts` pour l'API Claude
- Voir `src/utils/pdfSplitter.ts` pour la manipulation PDF

---

## üéâ R√©sultat

Le syst√®me permet maintenant :

‚úÖ **Analyse sans perte** de plans architecturaux PDF  
‚úÖ **Extraction exhaustive** de toutes les donn√©es techniques  
‚úÖ **G√©n√©ration automatique** de devis structur√©s  
‚úÖ **Pr√©servation 100%** de la qualit√© originale  
‚úÖ **Architecture microservices** r√©utilisable  
‚úÖ **TypeScript strict** pour la fiabilit√©  

---

## üìù Licence

Propri√©t√© de **IntuitionConcept BTP Platform**  
¬© 2025 - Tous droits r√©serv√©s

---

**D√©velopp√© avec ‚ù§Ô∏è pour la qualit√© et la pr√©cision**
